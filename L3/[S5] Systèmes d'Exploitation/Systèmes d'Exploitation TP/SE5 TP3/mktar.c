#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <string.h>
#include <libgen.h>
#include <sys/param.h>
#include "tarutils.h"

char zeros[BLOCKSIZE] = {0};
char buf[BLOCKSIZE];
struct posix_header hd;


/* ajoute un fichier de nom filename à l'archive ouverte (fd)
 * retourne 0 en cas de succès, 1 en cas d'échec */
int tar_one_file(int fd, char * filename) {
  struct stat st; 
  struct posix_header * phd = &hd;

  /* TODO : création de l'entête; commencer par le remplir de 0, puis
   * renseigner au moins les champs indispensables : typeflag, name,
   * mode, size, et _en dernier_ checksum.  
   * Pour typeflag, mode et size, utiliser stat() */
   int i;
   for(i=0; i<BLOCKSIZE; i++) write(fd, "/0", 1);
   if(stat(filename, &st)==-1){
	   printf("erreur acces statut\n");
	   return 1;
   }
   lseek(fd, -BLOCKSIZE, SEEK_CUR);
   if(S_ISREG(st.st_mode)) phd->typeflag='0';
   
   int len=strlen(filename);
   for(i=0; i<len; i++) phd->name[i]=filename[i];
   for(i=len; i<100; i++) phd->name[i]='\0';
   
   sprintf(phd->mode, "%07o", st.st_mode);
   sprintf(phd->size, "%01lo", st.st_size);
   

  /* calcul de checksum : indispensable pour gnu tar :-( */
  set_checksum(phd);

  /* TODO : ouverture du fichier à copier */
  int fd2=open(filename, O_RDONLY);
  if(fd2==-1){
	  printf("fichier pas cree\n");
	  return 1;
  }

  /* TODO : copie de l'entête dans l'archive */
  int w=write(fd, phd, BLOCKSIZE);
  if(w!=BLOCKSIZE){
	  printf("erreur copie entete\n");
	  return 1;
  }

  /* TODO : copie du fichier; ATTENTION à compléter le dernier bloc si
   * nécessaire */
   int filesize;
   sscanf(phd->size, "%o", &filesize);
   int r=read(fd2, phd, filesize);
   if(r!=filesize){
	  printf("erreur dans la lecture\n");
	  return 1;
   }
   w=write(fd, phd, filesize);
   if(w!=filesize){
	   printf("erreur dans l ecriture\n");
	   return 1;
   }
   lseek(fd, BLOCKSIZE-w, SEEK_CUR);//va au bloc suivant pour le prochain fichier a mktar

  /* TODO : fermeture du fichier copié */
  close(fd2);
  
  return 0;
}



int main(int argc, char **argv){
  if (argc < 3) {
    fprintf(stderr, "Usage : %s file.tar f1 [... fn]\n", argv[0]);
    exit(1);
  }

  /* TODO : création du fichier d'archive */
  int fd=open(argv[1], O_CREAT|O_WRONLY, S_IRUSR|S_IWUSR|S_IXUSR);
  if(fd==-1){
	  printf("archive pas cree\n");
	  return 1;
  }


  /* TODO : boucle principale pour ajouter chaque argv[i] l'un après
   * l'autre */
   for(int i=2; i<argc; i++) tar_one_file(fd, argv[i]);


  /* TODO : finalisation : ajout de deux blocs vides */
  int w=write(fd, zeros, BLOCKSIZE);
  w+=write(fd, zeros, BLOCKSIZE);
  if(w!=2*BLOCKSIZE){
	  printf("erreur finalisation\n");
	  exit(1);
  }

  /* TODO : fermeture du fichier tar */
  close(fd);

  exit(0);
}

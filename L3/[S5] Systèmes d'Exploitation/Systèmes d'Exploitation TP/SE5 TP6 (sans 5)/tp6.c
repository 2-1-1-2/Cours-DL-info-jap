#include "tp6.h"

void f1(unsigned int nprint, const char *parent, const char *child){
  int r;
  switch(r=fork()){
    case -1:
      printf("erreur fork\n");
      exit(1);
    case 0:
      for(int i=0; i<nprint; i++) printf("%s", child);
      break;
    default:
      for(int i=0; i<nprint; i++) printf("%s", parent);
  }
  printf("\n");
}

void f2(unsigned int nprocs, unsigned int nprint, const char *fname){
  int fd=open(fname, O_WRONLY);
  if(fd!=-1){
    printf("le fichier existe\n");
    exit(1);
  }
  if((fd=open(fname, O_WRONLY | O_CREAT))==-1){
    printf("la création de fichier a échoué\n");
    exit(1);
  }

  int f;
  for(int i=0; i<nprocs; i++){
    f=fork();
    if(f==-1){
      printf("erreur fork\n");
      exit(1);
    }

    dprintf(fd, "fd=%d ; ppid=%d ; ", fd, getppid());
    for(int j=0; j<nprint; j++) dprintf(fd, "%d ", getpid());
    dprintf(fd, "\n");
  }
  close(fd);
}

void f3(void){
  int n=1;
  printf("p1\n");
  switch(fork()){
    case -1:
      printf("erreur fork\n");
      exit(1);
    case 0:
      printf("|---p3\n");
      switch(fork()){
        case -1:
          printf("erreur fork\n");
          exit(1);
        case 0:
          printf("|   |---p5\n");
          switch(fork()){
            case -1:
              printf("erreur fork\n");
              exit(1);
            case 0:
              printf("|   |   |---p7\n");
              break;
            default:
              printf("|   |   |---p6\n");
              pause();
          }
          printf("|   |---p8\n");
          break;
        default:
          printf("|   |---p4\n");
          pause();
      }
      printf("|---p9\n");
      break;
    default:
      printf("|---p2\n");
      pause();//si on ne met pas cette ligne, les processus persistent ensuite
    }
}

void f4a(const char * cmd, int argc, char * argv[argc+1]){
  for(int i=0; i<2; i++){
    switch(fork()){
      case -1:
        printf("erreur fork\n");
        exit(1);
      case 0:
        if(execvp(cmd, argv)==-1){
          printf("error execv");
          exit(1);
        }
        break;
      default:
        wait(NULL);
        break;
    }
  }
}

void f4b(unsigned int ntimes, const char * cmd, int argc, char * argv[argc+1]){
  for(int i=0; i<ntimes; i++){
    switch(fork()){
      case -1:
        printf("erreur fork\n");
        exit(1);
      case 0:
        if(execvp(cmd, argv)==-1){
          printf("error execv");
          exit(1);
        }
        break;
      default:
        wait(NULL);
        break;
    }
  }
}

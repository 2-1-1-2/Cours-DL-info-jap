#include <unistd.h>
#include <stdlib.h>
#include <string.h>
#include <stdio.h>
#include "mppsh-parsing.h"
#define MAIN
#include "mppsh-exec.h"

#define BLEU   "\033[94;1m"
#define ROUGE  "\033[91;1m"
#define NORMAL "\033[00m"
#define PROMPT "mpsh $ "

char *argv[MAX_TOKENS];
char ligne[MAX_LINE];
int argc;

int main() {
  /* boucle principale */
  while(1) {
    /* affichage de l'invite de commande */
    dprintf(STDOUT_FILENO, "%s%s%s", BLEU, PROMPT, NORMAL);

    /* TODO : lecture de la ligne de commande */
    read(1, ligne, MAX_LINE);

    /* découpage selon les espaces */
    argc = line_to_tokens(ligne, argv);
    if (argc == 0) continue;
    if(strcmp("exit", argv[0])==0) return 0;

    /* TODO  : exécution de la commande */
    char * in_out[2];
    int* flag=malloc(sizeof(int));
    *flag=0;
    int bg=(strcmp(argv[argc-1], "&")==0)?1:0;

    if(strcmp("echo", argv[0])==0){
      if(argc==2) in_out[0]=argv[1];
      else if(argc==4){ //ne marche pas :)))
        argc=parse_redirections(argv, in_out, flag);
      }
      else continue; //nombre d'arguments incorrect
      argv[0]=(*flag==0)?"./copie":"./concatene";
    }
    else{
      in_out[0]=argv[1];
      in_out[1]=argv[2];
    }
printf("%s\n", argv[0]);
    exec_external(argv, in_out, *flag, bg);
    free(flag);
  }
  return 0;
}

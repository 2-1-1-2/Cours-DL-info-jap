#include "tp9.h"

void ex1(){
  int fd[2];
  if(pipe(fd)==-1){
    printf("error pipe\n");
    exit(1);
  }

  switch(fork()){
    case -1:
      printf("error fork\n");
      exit(1);
    case 0://lire
      close(fd[1]);
      int r;
      while(read(fd[0], &r, sizeof(int))>0) printf("%d\n", r);
      break;
    default://écrire
      srand(time(NULL));
      int n=rand()%101;
      printf("père %d\n", n);
      close(fd[0]);
      write(fd[1], &n, sizeof(n));
  }
}

void ex2(){
  int fd[2];
  if(pipe(fd)==-1){
    printf("error pipe\n");
    exit(1);
  }
  char buf[1];

  switch(fork()){
    case -1:
      printf("error fork\n");
      exit(1);
    case 0://écrire
      sleep(1);
      close(fd[0]);
      write(fd[1], "t", 1);
      printf("Fini\n");
      break;
    default://lire
      close(fd[1]);
      while(read(fd[0], buf, 1)>0) printf("Moi aussi : %s\n", buf);
  }
}

void ex4(){
  int fd1[2];
  int fd2[2];
  if(pipe(fd1)==-1){
    printf("error pipe1\n");
    exit(1);
  }
  if(pipe(fd2)==-1){
    printf("error pipe2\n");
    exit(1);
  }
  char buf[32];

  switch(fork()){
    case -1:
      printf("error fork\n");
      exit(1);
    case 0://écrire pong dans fd2, lire fd1
      close(fd1[1]);
      close(fd2[0]);
      while(1){
        //write
        srand(time(NULL));
        if(rand()%2==0){
          printf("Dehors, j'ai gagné !\n");
          write(fd2[1], "Dehors, j'ai gagné !\n", 32);
          exit(EXIT_SUCCESS);
        }
        write(fd2[1], "pong\n", 32);
        printf("pong\n");

        //read
        read(fd1[0], buf, 32);
        if(strcmp(buf, "Dehors, j'ai gagné !\n")==0){
          printf("Bravo... une petite revanche ?\n");
          exit(EXIT_SUCCESS);
        }
      }
      break;
    default://écrire ping dans fd1, lire fd2
      close(fd1[0]);
      close(fd2[1]);
      while(1){
        //read
        read(fd2[0], buf, 32);
        if(strcmp(buf, "Dehors, j'ai gagné !\n")==0){
          printf("Bravo... une petite revanche ?\n");
          exit(EXIT_SUCCESS);
        }

        //write
        srand(time(NULL));
        if(rand()%2==0){
          printf("Dehors, j'ai gagné !\n");
          write(fd1[1], "Dehors, j'ai gagné !\n", 32);
          exit(EXIT_SUCCESS);
        }
        write(fd1[1], "ping\n", 32);
        printf("ping\n");
      }
  }
}

//C'est pas comme ca que ca marche... :sob:
void ex5(int nbProc, int patatMax){
  int fd[nbProc][2];
  for(int i=0; i<nbProc; i++){
    if(pipe(fd[i])==-1){
      printf("error pipe%d\n", i);
      exit(1);
    }
  }
  for(int j=0; j<patatMax/nbProc+1; j++){
    for(int i=0; i<nbProc; i++){//chaque fork revient ici -> pour chaque i, i+1 processus en cours
      int t=(i==0)?nbProc-1:i-1;
      fork5(fd, t, i, patatMax);
    }
  }
}

void fork5(int fd[][2], int t, int i, int patatMax){
  int p;
  switch(fork()){
    case -1:
      printf("error fork\n");
      exit(1);
    case 0://lecture
      close(fd[t][1]);
      read(fd[t][0], &p, 1);
      if(p>patatMax){
        printf("Vivant ! (%d)\n", getpid());
        close(fd[i][0]);
        write(fd[i][1], &p, 1);
        exit(0);
      }
    default://ecriture
      printf("Je suis %d et la patate vaut %d (%d)", getpid(), ++p, i);
      close(fd[i][0]);
      if(p==patatMax){
        p++;
        write(fd[i][1], &p, 1);
        printf(" donc je meurs !\n");
        exit(0);
      }
      write(fd[i][1], &p, 1);
      printf("\n");
      break;
  }
}

int main(){
  //ex1();
  //ex2();
  //ex4();
  ex5(3, 4);
  return 0;
}
